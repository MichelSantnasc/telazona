<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin TELAZONA – Destaques</title>

  <!-- Fontes -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Silkscreen:wght@400&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <script src="https://unpkg.com/@phosphor-icons/web"></script>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    const supabase = createClient(
      'https://xygmdunlrbtyslvkqvyr.supabase.co',
      'sb_publishable_QKG5wJZ-qqPrXzZo8wmrFg_LEsjBGff'
    );

    let currentUser = null;
    let editingId = null;
    let currentUrls = [];

    const els = {
      login: document.getElementById('login-view'),
      main:  document.getElementById('main-view'),
      modal: document.getElementById('modal'),
      toast: document.getElementById('toast')
    };

    function toast(msg, error = false) {
      els.toast.textContent = msg;
      els.toast.className = `toast ${error ? 'error' : ''} show`;
      setTimeout(() => els.toast.className = 'toast', 3200);
    }

    async function checkAuth() {
      const { data: { session } } = await supabase.auth.getSession();
      currentUser = session?.user ?? null;
      render();
    }

    function render() {
      if (currentUser) {
        els.login.style.display = 'none';
        els.main.style.display = 'flex';
        loadGroups();
      } else {
        els.login.style.display = 'flex';
        els.main.style.display = 'none';
      }
    }

    document.getElementById('login-form').addEventListener('submit', async e => {
      e.preventDefault();
      const email    = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;

      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) return toast(error.message, true);

      currentUser = (await supabase.auth.getUser()).data.user;
      toast('Bem-vindo!');
      render();
    });

    document.getElementById('logout').onclick = async () => {
      await supabase.auth.signOut();
      currentUser = null;
      toast('Sessão encerrada');
      render();
    };

    async function loadGroups() {
      const container = document.getElementById('cards');
      container.innerHTML = '<div class="loading">Carregando destaques…</div>';

      const { data, error } = await supabase.from('featured').select('*').order('name');
      if (error) return container.innerHTML = `<div class="error">Erro: ${error.message}</div>`;

      container.innerHTML = data.length ? '' : '<div class="empty">Nenhum destaque criado ainda.</div>';

      data.forEach(g => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="card-header">
            <div class="title silkscreen">${g.name}</div>
            <div class="count">${g.lives.length} live${g.lives.length !== 1 ? 's' : ''}</div>
          </div>
          <div class="preview">
            ${g.lives.slice(0,4).map(u=>`<div class="url-line">${u.slice(0,60)}${u.length>60?'…':''}</div>`).join('')}
            ${g.lives.length > 4 ? `<div class="more">+${g.lives.length-4} mais</div>` : ''}
          </div>
          <div class="actions">
            <button class="btn edit" data-id="${g.id}" data-name="${g.name.replace(/"/g,'&quot;')}" data-lives='${JSON.stringify(g.lives)}'>
              <i class="ph ph-pencil-simple"></i> Editar
            </button>
            <button class="btn delete" onclick="removeCard('${g.id}', '${g.name.replace(/'/g,"\\'")}')">
              <i class="ph ph-trash"></i> Excluir
            </button>
          </div>
        `;
        container.appendChild(card);
      });

      document.querySelectorAll('.edit').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.id;
          const name = btn.dataset.name;
          let lives;
          try { lives = JSON.parse(btn.dataset.lives); } catch(e) { lives = []; }
          editCard(id, name, lives);
        });
      });
    }

    function getUrlListElement() { return document.getElementById('url-list'); }

    function renderUrls() {
      const list = getUrlListElement();
      if (!list) return;

      list.innerHTML = '';

      currentUrls.forEach((url, i) => {
        const row = document.createElement('div');
        row.className = 'url-row';
        row.innerHTML = `
          <input type="url" value="${url.replace(/"/g,'&quot;')}" class="url-in" />
          <button type="button" class="remove-btn">×</button>
        `;

        row.querySelector('input').addEventListener('input', e => {
          currentUrls[i] = e.target.value;
        });

        row.querySelector('.remove-btn').addEventListener('click', () => {
          currentUrls.splice(i, 1);
          renderUrls();
        });

        list.appendChild(row);
      });
    }

    window.newCard = () => {
      editingId = null;
      currentUrls = [''];
      document.getElementById('modal-title').textContent = 'Novo Destaque';
      document.getElementById('name').value = '';
      const modal = document.getElementById('modal');
      modal.showModal();
      setTimeout(renderUrls, 100);
    };

    window.editCard = (id, name, lives) => {
      editingId = id;
      currentUrls = Array.isArray(lives) ? [...lives] : [''];
      document.getElementById('modal-title').textContent = 'Editar Destaque';
      document.getElementById('name').value = name || '';
      const modal = document.getElementById('modal');
      modal.showModal();
      setTimeout(renderUrls, 100);
    };

    document.getElementById('add-url').addEventListener('click', () => {
      currentUrls.push('');
      renderUrls();
      setTimeout(() => {
        const inputs = document.querySelectorAll('.url-in');
        if (inputs.length) inputs[inputs.length-1].focus();
      }, 100);
    });

    document.getElementById('save').onclick = async () => {
      const name = document.getElementById('name').value.trim();
      if (!name) return toast('Nome é obrigatório', true);

      const cleanUrls = currentUrls.filter(u => u.trim() && u.startsWith('http'));

      let res;
      if (editingId) {
        res = await supabase.from('featured').update({ name, lives: cleanUrls }).eq('id', editingId);
      } else {
        res = await supabase.from('featured').insert([{ name, lives: cleanUrls }]);
      }

      if (res.error) return toast(res.error.message, true);

      toast('Salvo com sucesso!');
      document.getElementById('modal').close();
      loadGroups();
    };

    window.removeCard = async (id, name) => {
      if (!confirm(`Excluir "${name}"?`)) return;
      const { error } = await supabase.from('featured').delete().eq('id', id);
      if (error) toast(error.message, true);
      else {
        toast('Excluído');
        loadGroups();
      }
    };

    supabase.channel('admin-featured').on('postgres_changes', { event: '*', schema: 'public', table: 'featured' }, loadGroups).subscribe();

    checkAuth();
  </script>

  <style>
    :root {
      --bg:          #000000;
      --surface:     #0f0f0f;
      --surface2:    #161616;
      --border:      #222222;
      --text:        #ffffff;
      --text2:       #bbbbbb;
      --accent:      #00d084;
      --accent2:     #a855f7;
      --danger:      #ff4d4d;
      --radius:      12px;
    }

    * { margin:0; padding:0; box-sizing:border-box; }

    body {
      background: #000;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: 'Inter', system-ui, sans-serif;
      color: var(--text);
      overflow: hidden;
    }

    .tablet-frame {
      width:  min(100vw - 40px, 820px);
      height: min(100vh - 40px, 1080px);
      background: var(--surface);
      border: 14px solid #111;
      border-radius: 38px;
      box-shadow: 0 0 100px rgba(0,0,0,0.9);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .tablet-frame::before {
      content: '';
      position: absolute;
      top: 10px; left: 50%;
      transform: translateX(-50%);
      width: 140px;
      height: 6px;
      background: #222;
      border-radius: 10px;
      z-index: 10;
    }

    header {
      padding: 20px 24px;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
      text-align: center;
    }

    .logo {
      font-family: 'Silkscreen', cursive;
      font-weight: 400;
      font-size: 42px;
      letter-spacing: 4px;
      color: var(--accent);
    }

    main {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
    }

    .actions-top {
      display: flex;
      gap: 16px;
      margin-bottom: 32px;
      justify-content: center;
      flex-wrap: wrap;
    }

    button.btn {
      padding: 14px 28px;
      border-radius: var(--radius);
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      min-width: 160px;
    }

    .btn.primary {
      background: var(--accent);
      color: #000;
      border: none;
    }
    .btn.primary:hover { background: #00b36e; }

    .btn.secondary {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
    }
    .btn.secondary:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    #cards {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .card {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
    }

    .card-header {
      padding: 16px 20px;
      background: #0f0f0f;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text);
    }

    .card-count {
      font-size: 13px;
      color: var(--text2);
      background: rgba(0,208,132,0.1);
      padding: 4px 12px;
      border-radius: 20px;
    }

    .preview {
      padding: 16px 20px;
      font-size: 14px;
      color: var(--text2);
      line-height: 1.6;
    }

    .actions {
      padding: 16px 20px;
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      border-top: 1px solid var(--border);
    }

    /* Modal */
    dialog#modal {
      background: transparent;
      border: none;
      padding: 0;
      margin: auto;
      max-width: 92%;
      width: 680px;
      border-radius: 16px;
      overflow: hidden;
    }

    .modal-content {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 32px;
    }

    .modal-header {
      font-size: 28px;
      font-weight: 400;
      margin-bottom: 32px;
      color: var(--accent);
      font-family: 'Silkscreen', cursive;
      text-align: center;
    }

    label {
      display: block;
      margin: 24px 0 8px;
      font-size: 15px;
      color: var(--text2);
    }

    input {
      width: 100%;
      padding: 14px 16px;
      background: #0a0a0a;
      border: 1px solid var(--border);
      border-radius: 10px;
      color: white;
      font-size: 16px;
      margin-bottom: 20px;
    }

    .url-row {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
      align-items: center;
    }

    .url-in {
      flex: 1;
      padding: 12px;
      background: #0a0a0a;
      border: 1px solid var(--border);
      border-radius: 10px;
      color: white;
    }

    .remove-btn {
      background: var(--danger);
      color: white;
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      font-size: 18px;
      cursor: pointer;
    }

    .add-url {
      width: 100%;
      margin: 24px 0 32px;
      background: rgba(0,208,132,0.12);
      color: var(--accent);
      border: 1px solid rgba(0,208,132,0.3);
    }

    .add-url:hover {
      background: var(--accent);
      color: #000;
    }

    .modal-actions {
      display: flex;
      gap: 16px;
      justify-content: flex-end;
      margin-top: 32px;
    }

    .modal-actions .btn {
      min-width: 140px;
      padding: 14px 24px;
    }

    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--surface2);
      border: 1px solid var(--accent);
      color: var(--text);
      padding: 14px 32px;
      border-radius: var(--radius);
      font-weight: 500;
      box-shadow: 0 8px 24px rgba(0,0,0,0.6);
      opacity: 0;
      transition: all 0.4s;
      z-index: 9999;
      max-width: 90%;
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(-16px);
    }
  </style>
</head>
<body>

  <div class="tablet-frame">
    <div id="login-view">
      <div style="padding: 48px 32px; text-align: center;">
        <h1 class="logo silkscreen" style="font-size: 52px; margin-bottom: 32px;">TELAZONA</h1>
        <p style="color: var(--text2); margin-bottom: 48px; font-size: 18px;">Administração de Destaques</p>

        <form id="login-form">
          <input type="email" id="email" placeholder="Email" required autocomplete="email" />
          <input type="password" id="password" placeholder="Senha" required autocomplete="current-password" />
          <button type="submit" class="btn primary" style="margin-top: 32px; width: 100%; padding: 16px; font-size: 17px;">Entrar</button>
        </form>
      </div>
    </div>

    <div id="main-view" style="display:none; flex-direction: column; height: 100%;">
      <header>
        <h1 class="logo silkscreen">TELAZONA</h1>
      </header>

      <main>
        <div class="actions-top">
          <button class="btn primary" onclick="newCard()">+ Novo Destaque</button>
          <button id="logout" class="btn secondary">Sair</button>
        </div>

        <div id="cards"></div>
      </main>
    </div>

    <!-- Modal corrigido e proporcional -->
    <dialog id="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modal-title" class="silkscreen">Novo Destaque</h2>
        </div>

        <label>Nome do grupo</label>
        <input type="text" id="name" placeholder="Ex: Top Lives do Momento" />

        <label>Links das transmissões (um por linha)</label>
        <div id="url-list" style="max-height: 280px; overflow-y: auto; margin-bottom: 24px;"></div>

        <button id="add-url" class="btn secondary" style="width: 100%; margin-bottom: 32px;">
          + Adicionar URL
        </button>

        <div class="modal-actions">
          <button class="btn secondary" onclick="document.getElementById('modal').close()">Cancelar</button>
          <button id="save" class="btn primary">Salvar</button>
        </div>
      </div>
    </dialog>

    <div id="toast" class="toast"></div>
  </div>

</body>
</html>
