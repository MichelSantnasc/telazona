<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin TELAZONA – Destaques</title>

  <!-- Fontes -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Silkscreen:wght@400&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <script src="https://unpkg.com/@phosphor-icons/web"></script>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    const supabase = createClient(
      'https://xygmdunlrbtyslvkqvyr.supabase.co',
      'sb_publishable_QKG5wJZ-qqPrXzZo8wmrFg_LEsjBGff'
    );

    let currentUser = null;
    let editingId = null;
    let currentUrls = [];

    const els = {
      login: document.getElementById('login-view'),
      main:  document.getElementById('main-view'),
      modal: document.getElementById('modal'),
      toast: document.getElementById('toast')
    };

    function toast(msg, error = false) {
      els.toast.textContent = msg;
      els.toast.className = `toast ${error ? 'error' : ''} show`;
      setTimeout(() => els.toast.className = 'toast', 2800);
    }

    async function checkAuth() {
      const { data: { session } } = await supabase.auth.getSession();
      currentUser = session?.user ?? null;
      render();
    }

    function render() {
      if (currentUser) {
        els.login.style.display = 'none';
        els.main.style.display = 'block';
        loadGroups();
      } else {
        els.login.style.display = 'flex';
        els.main.style.display = 'none';
      }
    }

    document.getElementById('login-form').addEventListener('submit', async e => {
      e.preventDefault();
      const email    = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;

      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) return toast(error.message, true);

      currentUser = (await supabase.auth.getUser()).data.user;
      toast('Bem-vindo!');
      render();
    });

    document.getElementById('logout').onclick = async () => {
      await supabase.auth.signOut();
      currentUser = null;
      toast('Sessão encerrada');
      render();
    };

    // ==================== THUMBNAIL GENERATOR ====================
    function getThumbnailUrl(url) {
      if (!url) return '';
      const lower = url.toLowerCase();

      if (lower.includes('youtube.com') || lower.includes('youtu.be')) {
        const match = url.match(/(?:v=|youtu\.be\/|\/live\/|embed\/)([^"&?\/\s]{11})/i);
        return match ? `https://img.youtube.com/vi/${match[1]}/hqdefault.jpg` : '';
      }

      if (lower.includes('twitch.tv/')) {
        const match = lower.match(/twitch\.tv\/([a-z0-9_]+)/i);
        return match ? `https://static-cdn.jtvnw.net/previews-ttv/live_user_${match[1]}-320x180.jpg` : '';
      }

      if (lower.includes('kick.com/')) {
        const match = lower.match(/kick\.com\/([a-z0-9_]+)/i);
        return match ? `https://kick.com/${match[1]}/thumbnail` : 'https://via.placeholder.com/120x68/111/aaa?text=Kick';
      }

      return '';
    }

    async function loadGroups() {
      const container = document.getElementById('cards');
      container.innerHTML = '<div class="loading">Carregando destaques…</div>';

      const { data, error } = await supabase.from('featured').select('*').order('name');
      if (error) return container.innerHTML = `<div class="error">Erro: ${error.message}</div>`;

      container.innerHTML = data.length ? '' : '<div class="empty">Nenhum destaque criado ainda.</div>';

      data.forEach(g => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="card-header">
            <div class="title silkscreen">${g.name}</div>
            <div class="count">${g.lives.length} live${g.lives.length !== 1 ? 's' : ''}</div>
          </div>
          <div class="preview">
            ${g.lives.slice(0,4).map(u=>`<div class="url-line">${u.slice(0,55)}${u.length>55?'…':''}</div>`).join('')}
            ${g.lives.length > 4 ? `<div class="more">+${g.lives.length-4} mais</div>` : ''}
          </div>
          <div class="actions">
            <button class="btn edit" data-id="${g.id}" data-name="${g.name.replace(/"/g,'&quot;')}" data-lives='${JSON.stringify(g.lives)}'>
              <i class="ph ph-pencil-simple"></i> Editar
            </button>
            <button class="btn delete" onclick="removeCard('${g.id}', '${g.name.replace(/'/g,"\\'")}')">
              <i class="ph ph-trash"></i> Excluir
            </button>
          </div>
        `;
        container.appendChild(card);
      });

      document.querySelectorAll('.edit').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.id;
          const name = btn.dataset.name;
          let lives = [];
          try { lives = JSON.parse(btn.dataset.lives); } catch(e) {}
          editCard(id, name, lives);
        });
      });
    }

    function getUrlListElement() { return document.getElementById('url-list'); }

    function renderUrls() {
      const list = getUrlListElement();
      if (!list) return;

      list.innerHTML = '';

      currentUrls.forEach((url, i) => {
        const row = document.createElement('div');
        row.className = 'url-row';
        row.draggable = true;
        row.dataset.index = i;

        const thumbUrl = getThumbnailUrl(url);

        row.innerHTML = `
          <div class="drag-handle"><i class="ph ph-dots-six-vertical"></i></div>
          <input type="url" class="url-in" value="${url.replace(/"/g,'&quot;')}" placeholder="Cole o link da live" />
          <div class="thumbnail-preview">
            <img src="${thumbUrl}" alt="preview" onerror="this.src='https://via.placeholder.com/80x45/222/eee?text=?'" />
          </div>
          <button type="button" class="remove-btn">×</button>
        `;

        // Atualiza thumbnail em tempo real
        const input = row.querySelector('input');
        let timeout;
        input.addEventListener('input', () => {
          clearTimeout(timeout);
          timeout = setTimeout(() => {
            currentUrls[i] = input.value.trim();
            const img = row.querySelector('img');
            img.src = getThumbnailUrl(input.value);
            img.style.display = 'block';
          }, 500);
        });

        // Remover linha
        row.querySelector('.remove-btn').addEventListener('click', () => {
          currentUrls.splice(i, 1);
          renderUrls();
        });

        list.appendChild(row);
      });

      // Ativa drag & drop
      makeSortable(list);
    }

    function makeSortable(list) {
      let dragged;

      list.addEventListener('dragstart', e => {
        dragged = e.target.closest('.url-row');
        if (!dragged) return;
        dragged.style.opacity = 0.4;
      });

      list.addEventListener('dragend', e => {
        if (dragged) dragged.style.opacity = 1;
        dragged = null;
      });

      list.addEventListener('dragover', e => {
        e.preventDefault();
        const afterElement = getDragAfterElement(list, e.clientY);
        if (afterElement == null) {
          list.appendChild(dragged);
        } else {
          list.insertBefore(dragged, afterElement);
        }
      });

      list.addEventListener('drop', () => {
        // Atualiza o array na nova ordem visual
        currentUrls = Array.from(list.querySelectorAll('.url-row input')).map(input => input.value.trim()).filter(Boolean);
      });
    }

    function getDragAfterElement(container, y) {
      const draggableElements = [...container.querySelectorAll('.url-row:not(.dragging)')];

      return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
          return { offset: offset, element: child };
        } else {
          return closest;
        }
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    window.newCard = () => {
      editingId = null;
      currentUrls = [''];
      document.getElementById('modal-title').textContent = 'Novo Destaque';
      document.getElementById('name').value = '';
      document.getElementById('modal').showModal();
      setTimeout(renderUrls, 100);
    };

    window.editCard = (id, name, lives) => {
      editingId = id;
      currentUrls = Array.isArray(lives) ? [...lives] : [''];
      document.getElementById('modal-title').textContent = 'Editar Destaque';
      document.getElementById('name').value = name || '';
      document.getElementById('modal').showModal();
      setTimeout(renderUrls, 100);
    };

    document.getElementById('add-url').addEventListener('click', () => {
      currentUrls.push('');
      renderUrls();
      setTimeout(() => {
        const inputs = document.querySelectorAll('.url-in');
        if (inputs.length) inputs[inputs.length-1].focus();
      }, 100);
    });

    document.getElementById('save').onclick = async () => {
      const name = document.getElementById('name').value.trim();
      if (!name) return toast('Nome é obrigatório', true);

      const cleanUrls = currentUrls.filter(u => u.trim() && u.startsWith('http'));

      let res;
      if (editingId) {
        res = await supabase.from('featured').update({ name, lives: cleanUrls }).eq('id', editingId);
      } else {
        res = await supabase.from('featured').insert([{ name, lives: cleanUrls }]);
      }

      if (res.error) return toast(res.error.message, true);

      toast('Salvo com sucesso!');
      document.getElementById('modal').close();
      loadGroups();
    };

    window.removeCard = async (id, name) => {
      if (!confirm(`Excluir "${name}"?`)) return;
      const { error } = await supabase.from('featured').delete().eq('id', id);
      if (error) toast(error.message, true);
      else {
        toast('Excluído');
        loadGroups();
      }
    };

    supabase.channel('admin-featured').on('postgres_changes', { event: '*', schema: 'public', table: 'featured' }, loadGroups).subscribe();

    checkAuth();
  </script>

  <style>
    :root {
      --bg:          #000000;
      --surface:     #0f0f0f;
      --surface2:    #161616;
      --border:      #222222;
      --text:        #ffffff;
      --text2:       #bbbbbb;
      --accent:      #00d084;
      --accent2:     #a855f7;
      --danger:      #ff4d4d;
      --radius:      12px;
    }

    * { margin:0; padding:0; box-sizing:border-box; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', system-ui, sans-serif;
      min-height: 100vh;
    }

    .silkscreen { font-family: 'Silkscreen', cursive; }

    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      font-size: 32px;
      letter-spacing: 4px;
      color: var(--accent);
    }

    main {
      max-width: 1400px;
      margin: 0 auto;
      padding: 32px 24px;
    }

    .actions-top {
      display: flex;
      gap: 16px;
      margin-bottom: 40px;
      justify-content: center;
      flex-wrap: wrap;
    }

    button.btn {
      padding: 14px 28px;
      border-radius: var(--radius);
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.22s ease;
      min-width: 160px;
    }

    .btn.primary {
      background: var(--accent);
      color: #000;
      border: none;
    }
    .btn.primary:hover { background: #00b36e; transform: translateY(-2px); }

    .btn.secondary {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
    }
    .btn.secondary:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    #cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
      gap: 24px;
    }

    @media (max-width: 900px) {
      #cards { grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); }
    }

    @media (max-width: 600px) {
      #cards { grid-template-columns: 1fr; }
      main { padding: 24px 16px; }
      .actions-top { flex-direction: column; }
      .btn { width: 100%; justify-content: center; }
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      transition: all 0.25s ease;
    }

    .card:hover {
      transform: translateY(-6px);
      box-shadow: 0 12px 32px rgba(0,208,132,0.15);
      border-color: var(--accent);
    }

    .card-header {
      padding: 18px 24px;
      background: var(--surface2);
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--text);
    }

    .card-count {
      font-size: 14px;
      color: var(--text2);
      background: rgba(0,208,132,0.1);
      padding: 6px 14px;
      border-radius: 20px;
    }

    .preview {
      padding: 20px 24px;
      font-size: 14px;
      color: var(--text2);
      line-height: 1.6;
      max-height: 140px;
      overflow-y: auto;
    }

    .actions {
      padding: 18px 24px;
      display: flex;
      gap: 16px;
      justify-content: flex-end;
      border-top: 1px solid var(--border);
      background: var(--surface2);
    }

    /* Modal */
    dialog#modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      max-width: 92%;
      width: 680px;
      padding: 0;
      margin: auto;
    }

    .modal-content {
      padding: 32px;
    }

    .modal-header {
      font-size: 28px;
      font-weight: 400;
      margin-bottom: 32px;
      color: var(--accent);
      font-family: 'Silkscreen', cursive;
      text-align: center;
    }

    label {
      display: block;
      margin: 24px 0 8px;
      font-size: 15px;
      color: var(--text2);
    }

    input {
      width: 100%;
      padding: 14px 16px;
      background: #0a0a0a;
      border: 1px solid var(--border);
      border-radius: 10px;
      color: white;
      font-size: 16px;
      margin-bottom: 20px;
    }

    .url-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      background: #0a0a0a;
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      cursor: grab;
    }

    .url-row:active {
      cursor: grabbing;
    }

    .drag-handle {
      color: #666;
      font-size: 22px;
      padding: 4px 6px;
      cursor: grab;
    }

    .url-in {
      flex: 1;
      background: transparent;
      border: none;
      color: white;
      font-size: 15px;
      outline: none;
    }

    .thumbnail-preview {
      width: 80px;
      height: 45px;
      background: #000;
      border-radius: 6px;
      overflow: hidden;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .thumbnail-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .remove-btn {
      background: var(--danger);
      color: white;
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .add-url {
      width: 100%;
      margin: 24px 0 32px;
      background: rgba(0,208,132,0.12);
      color: var(--accent);
      border: 1px solid rgba(0,208,132,0.3);
    }

    .add-url:hover {
      background: var(--accent);
      color: #000;
    }

    .modal-actions {
      display: flex;
      gap: 16px;
      justify-content: flex-end;
      margin-top: 32px;
    }

    .modal-actions .btn {
      min-width: 140px;
      padding: 14px 24px;
    }

    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--surface2);
      border: 1px solid var(--accent);
      color: var(--text);
      padding: 14px 32px;
      border-radius: var(--radius);
      font-weight: 500;
      box-shadow: 0 8px 24px rgba(0,0,0,0.6);
      opacity: 0;
      transition: all 0.4s;
      z-index: 9999;
      max-width: 90%;
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(-16px);
    }

    .toast.error {
      background: rgba(255,77,77,0.2);
      border-color: var(--danger);
      color: #ffdddd;
    }

    .loading, .empty, .error {
      text-align: center;
      padding: 80px 20px;
      color: var(--text2);
      font-size: 18px;
    }

    /* Responsivo para celular */
    @media (max-width: 600px) {
      .url-row {
        padding: 10px;
        gap: 8px;
      }
      .thumbnail-preview {
        width: 64px;
        height: 36px;
      }
      .drag-handle {
        font-size: 20px;
      }
      .modal-content {
        padding: 24px 16px;
      }
    }
  </style>
</head>
<body>

  <div id="login-view">
    <div style="max-width: 420px; width: 90%; margin: 80px auto; padding: 48px 32px; background: var(--surface); border-radius: var(--radius); box-shadow: 0 20px 60px rgba(0,0,0,0.6); text-align: center;">
      <h1 class="logo silkscreen" style="font-size: 52px; margin-bottom: 32px;">TELAZONA</h1>
      <p style="color: var(--text2); margin-bottom: 48px; font-size: 18px;">Administração de Destaques</p>

      <form id="login-form">
        <input type="email" id="email" placeholder="Email" required autocomplete="email" />
        <input type="password" id="password" placeholder="Senha" required autocomplete="current-password" />
        <button type="submit" class="btn primary" style="margin-top: 32px; width: 100%; padding: 16px; font-size: 17px;">Entrar</button>
      </form>
    </div>
  </div>

  <div id="main-view" style="display:none;">
    <header>
      <div class="header-inner">
        <h1 class="logo silkscreen">TELAZONA</h1>
        <button id="logout" class="btn secondary">Sair</button>
      </div>
    </header>

    <main>
      <div class="actions-top">
        <button class="btn primary" onclick="newCard()">+ Novo Destaque</button>
      </div>

      <div id="cards"></div>
    </main>
  </div>

  <dialog id="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modal-title" class="silkscreen">Novo Destaque</h2>
      </div>

      <label>Nome do grupo</label>
      <input type="text" id="name" placeholder="Ex: Top Lives do Momento" />

      <label>Links das transmissões (arraste para reordenar)</label>
      <div id="url-list" style="max-height: 420px; overflow-y: auto; margin-bottom: 20px;"></div>

      <button id="add-url" class="btn secondary" style="width: 100%; margin-bottom: 24px;">
        + Adicionar URL
      </button>

      <div class="modal-actions">
        <button class="btn secondary" onclick="document.getElementById('modal').close()">Cancelar</button>
        <button id="save" class="btn primary">Salvar</button>
      </div>
    </div>
  </dialog>

  <div id="toast" class="toast"></div>

</body>
</html>
